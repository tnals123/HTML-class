<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/vs2015.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>hljs.highlightAll();</script>
    <script src="http://code.jquery.com/jquery-latest.js"></script>

    <style>
        pre{
            font-family: 'Source Code Pro';
            line-height: 1.2;
        }
        code{
            font-family: 'Source Code Pro';
            line-height: 1.5;
            height: 40px;
        }
    </style>

</head>

    <script>

        var count = 0;
        var my = 0;
        var codearray = [[]];
    
        function update_code() {
            const result_elem = document.querySelector("#highlighting-code code");
            const text = document.querySelector("#editing-code").value;
            let html = hljs.highlightAuto(text).value;
            result_elem.innerHTML =  html.replace(new RegExp("  ", "g"), "&nbsp; ");
        }

        function update_mycode(){
            var asdf = 0;
            var textcound = 0 ;
            var checkTagRequired = true;
            var first = 0;
            var final = 0;
            
            var result_elem = document.getElementById("count1");
            var text = document.getElementById("editing-code");
            var lines = text.value.split("\n");
            var lines2 = text.value.split("‛");
            var resultString = "";

            // for (var i = 0; i < lines.length; i++) {
            //     asdf = 0;

            //     for (var q = 0 ; q<lines[i].length; q++){
            //         if (lines[i][q] == "‛"){
            //             if (asdf == 0){
            //                 first = q;
            //                 asdf += 1;
            //             }
            //             else if (asdf == 1){
            //                 final = q;
            //                 asdf += 1;
            //             }
            //         }
            //     }
            //     if (asdf == 2){
            //         var mytext = lines[i].slice(first+1,final);
            //         let html = hljs.highlightAuto(mytext).value;
            //         if (lines[i].slice(0,first).length == 0){
            //             checkTagRequired = false;
            //         }
            //         else{
            //             checkTagRequired = true;
            //         }
            //     }

            // } 


            for (var i = 0; i < lines.length; i++) {
                 resultString += "<p>"+ lines[i] + "</p>"; 
            } 

            for (var i = 0 ; i <resultString.length; i++){
                if (resultString[i] == "‛"){
                    if (textcound == 0){
                            first = i;
                            textcound += 1;
                        }
                        else if (textcound == 1){
                            final = i;
                            textcound += 1;
                        }
                }
                if (textcound == 2){
                    // var html3 = html.replace(new RegExp('&lt;/<span class="hljs-selector-tag">p</span>&gt;&lt;<span class="hljs-selector-tag">p</span>&gt;', "g"),'<br>')
                    // console.log(html3)
                    // var html4 = html3.replace(new RegExp('<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>',"g"),'<br>')
                    
                    String.prototype.replaceAt = function(index, replacement) {
                        return this.substring(0, index) + replacement + this.substring(index + replacement.length);
                    }

                    var mytext = resultString.slice(first+1,final);
                    var mytext2 = mytext
                    console.log(mytext)
                    var mytext3 = mytext.replace(new RegExp("</p><p>", "g"), "<br>");
                    console.log(mytext3)
                    let html = hljs.highlightAuto(mytext3).value;


                    for (i = 0 ; i <html.length ; i ++){
                        try{
                            if (html[i] == " "){
                                if (html[i-1] && html[i+1] == " "){
                                    console.log(i)
                                    html = html.slice(0,i) + "&nbsp;" + html.slice(i+1)
                                    console.log(html)
                                }
                            }
                        }
                        catch(err){
                            //pass
                        }
                    }

                    // html = html.replace(new RegExp("  ", "g"), "&nbsp;");
                    console.log(html)
                    var html3 = html.replace(new RegExp('&lt;br&gt;', "g"),'<br>')
                    var html4 = html3.replace(new RegExp('<span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span>', "g"),'<br>')
                    // var html4 = html3.replace(new RegExp('<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>',"g"),'<br>')
                    //이제 줄 바꿈 처리하자;

                    resultString = resultString.replace(resultString.slice(first,final+1),"<pre id = 'asdf' " + " onchange = " + '"'+ auto_grow2(document.getElementById("asdf")) + '"' + "style = width:fit-content;" +"white-space:pre-line;" +"background-color:#D3D3D3;"+ "><code style = border-radius:3px;"+"word-break:break-all;"+">"  + html4 + "</code></pre>")
                    // resultString += "<code style = border-radius:3px;"+ "background-color:#D3D3D3;>" + html + "</code>"
                    textcound = 0;
                }

            }
            


            // var resultString ;
            // for (var i = 0; i < lines.length; i++) {
            //     asdf = 0;
            //     var first = 0 ;
            //     var final = 0 ;


            //     for (var q = 0 ; q<lines[i].length; q++){
            //         if (lines[i][q] == "‛"){
            //             if (asdf == 0){
            //                 first = q;
            //                 asdf += 1;
            //             }
            //             else if (asdf == 1){
            //                 final = q;
            //                 asdf += 1;
            //             }
            //         }
            //     }
            //     if (asdf == 2){
            //         var mytext = lines[i].slice(first+1,final);
            //         let html = hljs.highlightAuto(mytext).value;
            //         console.log(html)
            //         html.replace(new RegExp("  ", "g"), "&nbsp; ");
            //         resultString += "<p>"+ lines[i].slice(0,first) +"</p>" + "<code style = border-radius:3px;"+ "background-color:#D3D3D3;>" + html + "</code>"
            //     }
            //     else{
            //         resultString += "<p>"+ lines[i] + "</p>"; 
            //     }

            // } 


            // resultString += "</p>";


            result_elem.innerHTML = resultString;

        }



        function update_code2() {
            var result_elem = document.querySelector("#count1");
            var text = document.querySelector("#editing-code")
        }

        function auto_grow(element) {
            console.log(element);
            element.style.height = "5px";
            element.style.height = (element.scrollHeight)+"px";
        }
        function auto_grow2(element) {
            if (my > 0){
                console.log(element);
                element.style.height = "5px";
                element.style.height = (element.scrollHeight)+"px";
            }
            my += 1;
        }

        function resize() {
            const editor = document.querySelector('#editing-code');
            editor.style.height = "20px";
            editor.style.height = (editor.scrollHeight + 5)+"px";
        }


        function insertCodeBlock(position){
            var paper = document.getElementById("editing-code");
            var result_elem = document.querySelector("#count1");
            console.log(position);
 
            var paper_childtext = paper.childNodes[0];

            var result_childtext = result_elem.childNodes[0];
            var codeblock = document.createElement("textarea");
            // var codePre = document. createElement("pre");
            // var code = document.createElement("code");

            // codePre.setAttribute("id","highlighing-code");
            // codePre.setAttribute("class","hljs");
            // codePre.style.width = "300px";

            // codePre.appendChild(code);


            codeblock.style.height = "20px";
            codeblock.style.width = "300px";
            codeblock.style.overflow = "none";
            codeblock.style.resize = "none";


            codeblock.oninput = function(){
                auto_grow(this);
            }
            console.log(paper_childtext.length)
            console.log(paper_childtext.splitText(position));
            paper.insertBefore(codeblock, paper_childtext.splitText(position));
                    
        }

        // function check(){
        //     var mycount = 0
        //     var firstcount = 0;
        //     var finalcount = 0;
        //     var my = document.getElementById("editing-code");
        //     console.log(my.value)
        //     for (i = 0 ; i < my.value.length; i++){
        //         if (my.value[i] == "‛"){
        //             if (mycount == 0){
        //                 firstcount = i;
        //             }
        //             else if (mycount == 1){
        //                 finalcount = i;
        //             }
        //             mycount += 1;
        //         }
        //         if (mycount == 2){
        //             console.log(my.value.slice(firstcount+1,finalcount))
        //             update_mycode(firstcount+1,finalcount);
        //             mycount = 0;
        //         }
        //     }

        // }

        function insertAtCursor(myField, myValue) {
            if (document.selection) {
                myField.focus();
                sel = document.selection.createRange();
                sel.text = myValue;
            }
            else if (myField.selectionStart || myField.selectionStart == '0') {
                var startPos = myField.selectionStart;
                var endPos = myField.selectionEnd;
                myField.value = myField.value.substring(0, startPos)
                    + myValue
                    + myField.value.substring(endPos, myField.value.length);
            } else {
                myField.value += myValue;
            }
        }


        function printCaretPosition(){
            var cursorPosition = $('#editing-code').prop("selectionStart");
            // will get the value of the text area
            let x= $('#editing-code').val();
            

            // will get the value of the input box
            let text_to_insert="‛코드를 입력해 주세요!‛";

            // setting the updated value in the text area
            $('#editing-code').val(x.slice(0,cursorPosition)+"\n"+text_to_insert+x.slice(cursorPosition));

        }

        function node_walk(node, func) {
            var result = func(node);
            for(node = node.firstChild; result !== false && node; node = node.nextSibling)
                result = node_walk(node, func);
            return result;
            };

        window.onload = function showAndroidToast() {
            var mywidth = Android.getwidth();
            var px = Android.getwidth(mywidth);
            var mypx = px - 29;
            var mypx_codeblcok = px - 32;
            Android.showToast(String(mypx));
            var transe = document.getElementById("editing-code");
            var code_block = document.getElementById("highlighting-code")
            transe.style.width = mypx+"px";
            code_block.style.width = mypx_codeblcok+"px";
            document.getElementById(id).width = newContent;
        }

        var exam_script = {
        plus_num: function(num){
            try{
                window.java.getNum(num+num);
            }catch(err){
                console.log(">> [exam_script.plus_num()] " + err);
            }
        }
    }



        
    </script>

<body style="margin: 0;">
    <div style="border: 1px solid gray; border-radius: 3dp; height: fit-content; width: fit-content;" >
        <div style="border-bottom: 1px solid gray ;height:fit-content ;">
            <input type="button" style="height: 30px; margin-top: 5px; margin-left: 5px;" onclick="insertAtCursor(document.getElementById('editing-code'), '\n‛코드를 입력해 주세요!‛'); update_mycode()">
            <input id = ".click-me" type="button" style="height: 30px; margin-top: 5px; margin-left: 5px;">
            <input type="button" style="height: 30px; margin-top: 5px; margin-left: 5px;">
            <input type="button" style="height: 30px; margin-top: 5px; margin-left: 5px;">
            <div style=" position:absolute; display: inline-block; top: 0; bottom: 0; width: 10px; background-color: gray; height: 7%; margin-left: 10px;"></div>
        
        </div>
        <textarea contenteditable="true"
        id="editing-code"
        placeholder="소스코드 입력"
        spellcheck="false"
        style=" border: none; min-height:200px; max-height: 200px; width:400px; top: 10px; resize: none; overflow: scroll; margin : 0 "
        onclick="update_code2(); resize();  "
        oninput="update_mycode(); resize();">
dksdugktpdy
whtnalsdlqsek

    </textarea>
    </div>

    <!-- <pre
        style="height:300px;width:600px;top: 10px; background-color: white; color: black;"
        id="highlighting-code"
        class="hljs">
            <code></code>
    </pre> -->

    <pre class = "hljs" style="word-break: break-all; white-space: pre-wrap; height:400px; width:600px;top: 10px; background-color: white; color: black" id = "count1">
    </pre>




    

</body>
</html>